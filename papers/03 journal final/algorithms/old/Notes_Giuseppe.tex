\documentclass[10pt]{article}
\usepackage{amsmath} % assumes amsmath package installed
\usepackage{amsfonts,mathrsfs}
\usepackage{amssymb}
\usepackage{color}
\usepackage{graphicx}
\usepackage{epsfig}
\usepackage{subfigure}
\usepackage{enumerate}
\usepackage{algorithm,algorithmicx}


\def\bbbr{{\rm I\!R}}
%\input{macros.tex}
%\input{slide_macros.tex}

\newtheorem{definition}{Definition}{\it}{}
\newtheorem{example}{Example}{\it}{}
\newtheorem{corollary}{Corollary}{\it}{}
\newtheorem{proposition}{Proposition}{\it}{}
\newtheorem{lemma}{Lemma}{\it}{}
\newtheorem{theorem}{Theorem}{\it}{}
\newtheorem{remark}{Remark}{\it}{}
\newtheorem{assumption}{Assumption}{\it}{}
\newenvironment{proof}[1][Proof]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}
%\newcommand{\proof}{\vspace{1mm}\noindent{\it Proof.}\quad}
%\def\qed{\quad{$\square$}} 

\textwidth=6.3in
\textheight 9in 
\setlength{\topmargin}{-0.5in}
\setlength{\oddsidemargin}{0.1in} 
\setlength{\evensidemargin}{0.1in}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\an#1{{{\bf \color{blue}#1}}}
\def\o{\omega}
\def\vmean{v^{\rm mean}}
\def\vmax{v^{\rm max}}
\def\e{\epsilon}
\newcommand{\todo}[1]{\vspace{5 mm}\par \noindent \marginpar{\textsc{ToDo}}
\framebox{\begin{minipage}[c]{0.9 \textwidth} \tt #1
\end{minipage}}\vspace{5 mm}\par}

% Boldsymbols, mathcal, mathbb
\newcommand{\bs}{\boldsymbol}
\newcommand{\mc}{\mathcal}
\newcommand{\bb}{\mathbb}
\newcommand{\R}{\bb R}

%norm
\newcommand{\norm}[1]{\left\|#1\right\|}

% Operators and notations
\newcommand{\dom}{\operatorname{dom}}
\newcommand{\iP}{\mathcal{P}}
\newcommand{\B}{\mathcal{C}}
\newcommand{\red}{\textcolor{red}}
\newcommand{\blue}{\textcolor{blue}}
\newcommand{\argmin}{\operatorname{argmin}}
\newcommand{\mini}{\operatorname{minimize}}
\newcommand{\Proj}{\mathrm{Proj}}
\newcommand{\fix}{\mathrm{fix}}
\newcommand{\proj}{\mathrm{proj}}
\newcommand{\prox}{\mathrm{prox}}
\newcommand{\Id}{\mathrm{Id}}
\newcommand{\Res}{\operatorname{J}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\blkdiag}{\operatorname{blkdiag}}
\newcommand{\col}{\operatorname{col}}
\newcommand{\zer}{\operatorname{zer}}
\newcommand{\nulls}{\operatorname{Null}}
\newcommand{\range}{\operatorname{Range}}
\newcommand{\dist}{\mathrm{dist}}
\newcommand{\nc}{\mathrm{N}}
\newcommand{\0}{\mathbf{0}}
\newcommand{\1}{\mathbf{1}}
\newcommand{\half}{^1\hspace*{-.1em}/_2}

%Roman numbers
\newcommand{\rmnum}[1]{\romannumeral #1}
\newcommand{\Rmnum}[1]{\expandafter\@slowromancap\romannumeral #1@}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{Decentralized Algorithms for Generalized Nash Equilibrium Seeking in Peer-to-peer Electricity Markets}
\author{Giuseppe Belgioioso}
\begin{document}
\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Problem statement}
Consider the same setup of the ECC 2020 paper.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Algorithms}
\subsection{Semi-decentralized}

The algorithm presented in this section corresponds to \cite[Alg. 1]{belgioioso2018projected} applied on the setup of the ECC 2020 paper.

Consider the following choices for the step-sizes in Algorithm 1.
\smallskip

\begin{assumption}[Step size selection]\label{ass:SS-choice2}
For all $i \in \mc N$, set $A_i = \blkdiag(  A_{i,1},\ldots, A_{i,H})$, where $A_{i,h} = \diag \left(
\alpha_{i,h}^{\mathrm{dg}},  \; \alpha_{i,h}^{\mathrm{st}},\;  \alpha_{i,h}^{\mathrm{mg}}, \; \{ \alpha_{(i,j),h}^{\mathrm{tr}} \}_{j\in\mathcal{N}_i} \right)$, for all $ h \in \mc H$, with $\alpha_{i,h}^{\mathrm{dg}}, \; \alpha_{i,h}^{\mathrm{st}}>0$ and $\alpha_{(i,j),h}^{\mathrm{tr}} > |\mc N_i|$, for all $ j \in \mc N_i$; $\beta_{(i,j)} = \beta < \frac{1}{2}$ for all $j \in \mc N_i $; $\gamma < N$

{\hfill $\square$}
\end{assumption}


\begin{algorithm}[H]

	\caption{Semi-decentralized GWE seeking for P2P Energy Markets}
	
	\medskip
	\noindent
	%
	\textbf{Initialization}:
	For all $ i \in \mc N$, set locally:
	\begin{enumerate}[(a)]
		\item Initial conditions: $u_i(0) \in \mc U_i$, $\mu_{(i,j)}(0) = \0$ for all $ j \in \mc N_i$, and $\lambda(0) \in \R^{2H}_{\geq 0}$.
		
		\item Step-sizes:
$A_i$, $\{\beta_{ij}\}_{j \in \mc N_i}$,$\gamma$ as in Assumption \ref{ass:SS-choice2}.

	\end{enumerate}
	
	
	\medskip
	\noindent
	\textbf{Iterate until convergence}:\\[1em]
\textbf{Local}. For each agent $i \in \mc N$:

\begin{enumerate}[(1)]
\item Strategy update:
%	\begin{align*} 
%	u_i(k+1) = 
%	\underset{z \in \mc U_i}{\argmin} \; \left\{
%	J_{i} \Big( z, \sigma(k) \Big) \right. 
%	+{\lambda(k)}^\top 
%	\left[
%	\begin{smallmatrix}
%	S^{\textrm{mg}}_i \\
%	- S^{\textrm{mg}}_i
%	\end{smallmatrix}
%	\right]
%	z 
%	%
%	+ \sum_{j \in \mc N_i} \Big( {\mu_{(i,j)}(k)}^\top S^{\textrm{tr}}_{(i,j)} z \Big)
%	\left.
%	\textstyle
%	+ \frac{1}{2} {\|z - u_i(k) \|}^2_{A_i}
%	\right\}
%	.
%	\end{align*}
	\begin{align*} 
	\textstyle
&	a_i(k) = 
	A_i^{-1} \left(
	{\left( \left[
	\begin{smallmatrix}
	 1 \\
	- 1
	\end{smallmatrix} 
	\right] \otimes S^{\textrm{mg}}_i \right)}^\top
	{\lambda(k)}
	%
	+ 
	\sum_{j \in \mc N_i}  {\big(S^{\textrm{tr}}_{(i,j)}\big)}^\top {\mu_{(i,j)}(k)} \right) \\
	%
	%
	\textstyle
&	u_i(k+1) =
\left\{
\begin{array}{r l}
	\underset{\xi \in \R^{n_i}}{\argmin} & 
	J_{i} \big( \xi, \sigma(k) \big) 
	+ \frac{1}{2}
	\left\| \xi - u_i(k) + a_i(k) 
	\textstyle
	  \right\|^2_{A_i} \\
	  \text{s.t. } & \xi \in \mc U_i
\end{array} 
	\right.
	\end{align*}

\medskip
\item Communication with Neighboring Agents and Central Coordinator (CC):

	\begin{align*}	
	\begin{array}{l c c r c}
	\text{(a)} &  S^{\textrm{mg}} u_{i}(k+1) &
	\longrightarrow & \text{ CC,} & \\[.2em]
	\text{(b)} & S^{\textrm{tr}}_{(i,j)} u_{i}(k+1) &
	\longrightarrow & j, & \quad \text{ for all } j \in \mc N_i. 
	\end{array}
	\end{align*}

\item Dual variables (reciprocity constraints) update, $\forall j \in \mc N_i$:
	\vspace*{-.5em}
	\begin{align*}
&	b_{(i,j)}(k+1)  =  S^{\textrm{tr}}_{(i,j)} u_{i}(k+1) + S^{\textrm{tr}}_{(j,i)}  u_{j}(k+1), \\
%
&	\mu_{(i,j)}(k+1) = \mu_{(i,j)}(k) + \beta_{ij} \left( 
	2  b_{(i,j)}(k+1) - b_{(i,j)}(k)
	\right).
	\end{align*}
\end{enumerate}

\bigskip
\textbf{Central}.	
	\begin{enumerate}[(1)]
	\item Average strategy update
	 \begin{align*}
	 \sigma(k+1) = \frac{1}{N} \sum_{i=1}^N S_i^{\text{mg}} \, u_i(k+1)
	 \end{align*}	

	\smallskip	
	\item Dual variable (grid constraints) update:
	\vspace*{-.5em}
	\begin{align*}
	\lambda(k+1) = \textstyle
	\proj_{\R^{2 H}_{\geq 0}}\left( 
	\lambda(k) + \gamma \left( 
	\left[
	\begin{smallmatrix}
	1\\
	- 1 
	\end{smallmatrix}
	\right] \otimes (2 \sigma(k+1)- \sigma(k)) 
	-
	\left[
	\begin{smallmatrix}
	\overline{p}^{\mathrm{mg}}\1_{H} \\
	-     \underline{p}^{\mathrm{mg}}N \1_{H}
	\end{smallmatrix} 
	\right]  
	\right)
	\right).
	\end{align*}
	 
	 
	 \smallskip
	 \item Broadcast to all the prosumers
	 	\begin{align*}
	\begin{array}{l c c c }
\sigma(k+1), \, \lambda(k+1) &
	\longrightarrow & \text{ Prosumers} 
	\end{array}
	\end{align*}
	\end{enumerate}
	
\end{algorithm}

\newpage
\subsection{Fully-distributed}

The algorithm presented in this section is a variation of \cite[Alg. 3]{belgioioso2019distributed} for the setup considered in the ECC 2020 paper.

Consider the following mixing matrix.
\begin{assumption} \label{ass:DSMM}
For all $k \in \bb N$, the matrix $W=[w_{i,j}] $ satisfies the following conditions:
\begin{enumerate}[(i)]
\item (Edge utilization) Let $i,j \in \mc I$, $i \neq j$. If $(i,j) \in \mc E_k$, $w_{i,j} \geq \epsilon$, for some $\epsilon > 0$; $w_{i,j} = 0$ otherwise;
\item (Positive diagonal) For all $i \in \mc I$, $w_{i,i} > \epsilon$;
\item (Double-stochasticity) $W \1 = \1$, $\1^\top W = \1^\top$.
{\hfill $\square$}
\end{enumerate}
\end{assumption}

\smallskip
Assumption \ref{ass:DSMM} is strong but typical for multiagent coordination and optimization \cite{margellos2018distributed}. For an undirected graph it can be fulfilled, for example, by using Metropolis weights:
\begin{equation} \label{eq:Metropolis}
w_{i,j}=
\begin{cases}
(\max\{|\mc N_i|, |\mc N_j| \})^{-1} & \text{if } (i,j) \in \mc E,\\
0 & \text{if } (i,j) \not\in \mc E, %\, i \neq j,
\\
1- \sum_{\ell \in \mc N_i} w_{i,\ell} & \text{if } i=j.
\end{cases}
\end{equation}

\medskip

Consider the following choices for the step-sizes in Algorithm 2.

\begin{assumption}[Step size selection]\label{ass:SS-choiceFD}
For all $i \in \mc N$, set $A_i = \blkdiag(  A_{i,1},\ldots, A_{i,H})$, where $A_{i,h} = \diag \left(
\alpha_{i,h}^{\mathrm{dg}},  \; \alpha_{i,h}^{\mathrm{st}},\;  \alpha_{i,h}^{\mathrm{mg}}, \; \{ \alpha_{(i,j),h}^{\mathrm{tr}} \}_{j\in\mathcal{N}_i} \right)$, for all $ h \in \mc H$, with $\alpha_{i,h}^{\mathrm{dg}}, \; \alpha_{i,h}^{\mathrm{st}}>0$, $\alpha_{i,h}^{\text{mg}} > q_{h}^{\text{mg}} + 1$ and $\alpha_{(i,j),h}^{\mathrm{tr}} > |\mc N_i|$, for all $ j \in \mc N_i$; $\beta_{(i,j)} = \beta < \frac{1}{2}$ for all $j \in \mc N_i $; $\gamma < 1.$

{\hfill $\square$}
\end{assumption}

\begin{assumption}[Kransol'skii--Mann step] \label{ass:van-ss} The sequence $( \delta(k) )_{k \in \bb N}$ satisfies the following conditions:
\begin{enumerate}[(i)]
\item (non-increasing) $0 \le \delta(k)^{k+1} \le \delta(k) \le 1$, for all $k \ge 0$;
\item (non-summable) $\sum_{k=0}^\infty \delta(k) = \infty$;
\item (square-summable) $\sum_{k=0}^\infty {\delta(k)}^2 < \infty$.
{\hfill $\square$}
\end{enumerate}
\end{assumption}

\begin{remark}[Vanishing KM steps seem not necessary in practice]
For the numerical studies, we can use $\delta(k)=1$, for all $k \in \bb N$.
\end{remark}



\begin{algorithm}[H]

	\caption{Fully-Distributed GWE seeking for P2P Energy Markets}
	
	\medskip
	\noindent
	%
	\textbf{Initialization}:
	For all $ i \in \mc N$, set locally:
	\begin{enumerate}[(a)]
		\item Initial conditions: $u_i(-1), u_i(0), \tilde u_i(-1) \in \mc U_i$, $\mu_{(i,j)}(0) = \0$ for all $ j \in \mc N_i$, $\lambda_i(0) \in \R^{2H}_{\geq 0}$, $\sigma_i(0)=x_i(0)$, $z_i(0) = \lambda_i(0)$, $y_i(0) = 2\tilde u_i(-1)- u_i(-1) -  \frac{1}{N} \left[
	\begin{smallmatrix}
	\overline{p}^{\mathrm{mg}}\1_{H} \\
	-     \underline{p}^{\mathrm{mg}}N \1_{H}
	\end{smallmatrix} 
	\right]  		
		$.
		
		\item Step-sizes:
$A_i$, $\{\beta_{ij}\}_{j \in \mc N_i}$ and $\gamma_i$ as in Assumption \ref{ass:SS-choiceFD}; $\{ \delta_i(k)\}_{k \in \bb N}$ as in Assumption \ref{ass:van-ss}.

	\end{enumerate}
	
	
	\medskip
	\noindent
	\textbf{Iterate until convergence}:\\[.5em]
\textbf{Local}. For each agent $i \in \mc N$:

\begin{enumerate}[(1)]
\item Communication with neighboring agents
$$ \big\{ S^{\textrm{mg}}  u_{i}(k+1), \, \sigma_i(k), \, y_i(k), \, z_i(k) \big\} \quad \longrightarrow \quad j, \text{ for all } j \in \mc N_i,$$

\item Distributed averaging
\begin{align*} \textstyle
  \hat{\sigma}_i(k) = \sum_{j =1}^N w_{i,j} \sigma_j(k),
  \quad
   \hat y_i(k) = \sum_{j =1}^N w_{i,j}  y_j(k), 
   \quad
  \hat z_i(k) = \sum_{j =1}^N w_{i,j}  z_j(k),
\end{align*}

\item Strategy update
	\begin{align*} 
	\textstyle
&	d_i(k) = 
	A_i^{-1} \left(
	{ \left( \left[
	\begin{smallmatrix}
	1 \\
	- 1
	\end{smallmatrix}
	\right] \otimes S^{\textrm{mg}}_i \right)}^\top
	\hat z_i(k)
	%
	+
	\sum_{j \in \mc N_i}  {\big(S^{\textrm{tr}}_{(i,j)}\big)}^\top {\mu_{(i,j)}(k)} 
	\right) \\
	%
	%
	\textstyle
&	
\tilde u_i(k) = 
\left\{
\begin{array}{r l}
	\underset{\xi \in \R^{n_i}}{\argmin} &
	J_{i} \big( \xi , \hat \sigma_i(k) \big) 
	+ \frac{1}{2}
	\left\| \xi - u_i(k) + d_i(k) 
	\textstyle
	  \right\|^2_{A_i} \\
	  \text{s.t.} & \xi \in \mc U_i
\end{array}
\right.
	\end{align*}

\item Dual variables (reciprocity constraints) update, $\forall j \in \mc N_i$:
	\vspace*{-.5em}
	\begin{align*}
	\tilde \mu_{(i,j)}(k) = \mu_{(i,j)}(k) + \beta_{ij} \left( 
	2  S^{\textrm{tr}}_{(i,j)} \tilde u_{i}(k)- S^{\textrm{tr}}_{(i,j)} u_{i}(k) +  2S^{\textrm{tr}}_{(j,i)}  \tilde u_{j}(k)  - S^{\textrm{tr}}_{(j,i)}  u_{j}(k) 
	\right).
	\end{align*}
	
\item Dynamic tracking of the estimate $y_i$:
\begin{align*}
y_i(k+1) = \hat y_i(k) + \big(2 \tilde u_i(k)-u_i(k)\big)-\big( 2 \tilde u_i(k-1) - u_i(k-1) \big),
\end{align*}

	\item Dual variable (grid constraints) update:
	\vspace*{-.5em}
	\begin{align*}
	\tilde \lambda_i(k) = \textstyle
	\proj_{\R^{2 H}_{\geq 0}} \big( 
	\lambda_i(k) + \gamma_i \left( 
	\left[
	\begin{smallmatrix}
	1\\
	- 1 
	\end{smallmatrix}
	\right] \otimes y_i(k+1) - \lambda_i(k) + \hat z_i(k)
	\right)
	\big),
	\end{align*}
	
	\item Krasnosel'skii-Mann process
	 \begin{align*}
u_i(k+1) &= u_i(k) + \delta_i(k) \big( \tilde u_i(k)
- u_i(k) \big),\\
%
\mu_{(i,j)}(k+1) &= \mu_{(i,j)}(k) + \delta_i(k) \big( \tilde \mu_{(i,j)}(k)
- \mu_{(i,j)}(k) \big), \quad \forall j \in \mc N_i,\\
%
\lambda_i(k+1) &= \lambda_i(k) + \delta_i(k) \big( \tilde \lambda(k)
- \lambda_i(k) \big), 	
\end{align*}	

	\item Dynamic tracking of the estimates $\sigma_i$ and $z_i$:
	\vspace*{-.5em}
	\begin{align*}
\sigma_i(k+1) &= \hat \sigma(k) + u_i(k+1) - u_i(k),\\
%
z_i(k+1) &= \hat z_i(k) + \lambda_i(k+1) - \lambda_i(k)
	\end{align*}
\end{enumerate}
	
\end{algorithm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{IEEEtran}
\bibliography{IEEEfull,library}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}

